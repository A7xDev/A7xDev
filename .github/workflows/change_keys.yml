name: Change A7xDev Key

# تشغيل يدوي
on:
  workflow_dispatch:

jobs:
  change_key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Requests
        run: pip install requests

      - name: Change Keys
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
        run: |
          python3 - << 'EOF'
          import os, random, string, base64
          import requests, json

          token = os.environ["GITHUB_TOKEN"]
          repo_owner = os.environ["GITHUB_REPOSITORY"].split("/")[0]
          repo_name = os.environ["GITHUB_REPOSITORY"].split("/")[1]
          branch = "main"

          # الملفات التي سيتم تعديلها مع رقم السطر الذي يحتوي على المفتاح
          files_to_update = [
              ("A7xDev_Key_AR.lua", 8),
              ("A7xDev_Key_EN.lua", 8)
          ]

          # توليد مفتاح جديد مشترك للملفين
          new_key = "A7x" + ''.join(random.choices(string.digits, k=5))

          for file_path, key_line_number in files_to_update:
              key_line_index = key_line_number - 1  # index يبدأ من صفر

              # جلب الملف الحالي
              url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/contents/{file_path}"
              headers = {"Authorization": f"token {token}"}
              r = requests.get(url, headers=headers)
              data = r.json()
              content = base64.b64decode(data['content']).decode()

              # تعديل السطر
              lines = content.split("\n")
              lines[key_line_index] = f'local correctKey = "{new_key}"'
              new_content = "\n".join(lines)
              b64_content = base64.b64encode(new_content.encode()).decode()

              # رفع الملف المعدل
              payload = {
                  "message": f"تغيير المفتاح في {file_path}",
                  "content": b64_content,
                  "sha": data['sha'],
                  "branch": branch
              }
              r = requests.put(url, headers=headers, data=json.dumps(payload))
              print(f"🔑 {file_path} المفتاح الجديد هو: {new_key}")
          EOF
