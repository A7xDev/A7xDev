name: Change A7xDev Key

# ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
on:
  workflow_dispatch:

jobs:
  change_key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Requests
        run: pip install requests

      - name: Change Key
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
          FILE_PATH: "A7xDev_Key.lua"
          KEY_LINE: "8"
        run: |
          python3 - << 'EOF'
          import os, random, string, base64
          import requests, json

          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          token = os.environ["GITHUB_TOKEN"]
          repo_owner = os.environ["GITHUB_REPOSITORY"].split("/")[0]
          repo_name = os.environ["GITHUB_REPOSITORY"].split("/")[1]
          branch = "main"
          file_path = os.environ["FILE_PATH"]
          key_line_number = int(os.environ["KEY_LINE"]) - 1  # index

          # ØªÙˆÙ„ÙŠØ¯ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯
          new_key = ''.join(random.choices(string.ascii_letters + string.digits, k=10))

          # Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
          url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/contents/{file_path}"
          headers = {"Authorization": f"token {token}"}
          r = requests.get(url, headers=headers)
          data = r.json()
          content = base64.b64decode(data['content']).decode()

          # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø·Ø±
          lines = content.split("\n")
          lines[key_line_number] = f'local correctKey = "{new_key}"'
          new_content = "\n".join(lines)
          b64_content = base64.b64encode(new_content.encode()).decode()

          # Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø¯Ù„
          payload = {
              "message": "ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­",
              "content": b64_content,
              "sha": data['sha'],
              "branch": branch
          }
          r = requests.put(url, headers=headers, data=json.dumps(payload))
          print(f"ðŸ”‘ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ùˆ: {new_key}")
          EOF
